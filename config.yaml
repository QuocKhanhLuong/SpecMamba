# =============================================================================
# EGM-Net / SpecMamba - Unified Configuration
# =============================================================================
# All options for the ACDC segmentation pipeline
# =============================================================================

# Quick preset (overridden by individual settings below)
# Options: baseline, lite, sota, bio, spectral, attention
preset: "sota"

# =============================================================================
# MODEL CONFIGURATION
# =============================================================================
model:
  name: "EGMNet"
  in_channels: 3            # 1 for grayscale, 3 for RGB
  num_classes: 4            # ACDC: 0=BG, 1=RV, 2=MYO, 3=LV
  img_size: 224             # Input image size
  
  # Backbone settings
  backbone:
    type: "hrnet"           # "hrnet" or "simple"
    base_channels: 64       # Base channel width (32, 48, 64)
    num_stages: 4           # Number of HRNet stages
    blocks_per_stage: 2     # Blocks per stage
    
  # ==========================================================================
  # BLOCK TYPE (replaces basic blocks inside HRNet stages)
  # ==========================================================================
  # Available options:
  #   - "basic"             : Standard residual block (default HRNet)
  #   - "convnext"          : ConvNeXt Block (SOTA CNN, 7x7 depthwise)
  #   - "dcn"               : Deformable Conv v2 (learnable kernel offsets)
  #   - "inverted_residual" : MobileNetV2 style (lightweight)
  #   - "swin"              : Swin Transformer (window attention)
  #   - "fno"               : Fourier Neural Operator (spectral conv)
  #   - "wavelet"           : Wavelet Transform Block (multi-scale)
  #   - "rwkv"              : RWKV Block (linear attention)
  # ==========================================================================
  block:
    type: "dcn"             # Recommended: "dcn" for best accuracy
    depth: 2                # Blocks per stage (overridden by asymmetric config)
    
    # Asymmetric block depths per stage (advanced)
    asymmetric:
      enabled: false
      stage2: 2
      stage3: 4
      stage4: 6
    
    # Dilation pyramid for DCN (ASPP-style multi-scale)
    dilation_pyramid:
      enabled: true         # Auto-use dilations [1,2,4,8,16,32] for DCN
    
    # Block-specific settings
    convnext:
      drop_path: 0.1
      layer_scale_init: 1e-6
      
    swin:
      num_heads: 8
      window_size: 7
      mlp_ratio: 4.0
      
    fno:
      modes: 16
      mlp_ratio: 2.0
      
    mamba:
      d_state: 16
      d_conv: 4
      expand: 2
      
  # Additional components
  components:
    use_mamba: false        # Use Mamba SSM blocks (requires mamba-ssm)
    use_spectral: false     # Use spectral FFT processing
    use_pointrend: true     # Use PointRend for boundary refinement

# =============================================================================
# PREPROCESSING (DoG Layer)
# =============================================================================
preprocessing:
  dog:
    enabled: true           # Enable Difference of Gaussians
    scales: [[1.0, 2.0], [2.0, 4.0]]
    kernel_size: 15
    concat_original: true

# =============================================================================
# SEGMENTATION HEADS
# =============================================================================
heads:
  # Coarse Head (main segmentation output)
  coarse:
    type: "constellation"   # "constellation" (RBF), "linear", "conv"
    enabled: true
    embedding_dim: 2
    init_gamma: 1.0
    
  # Fine Head (implicit refinement)
  fine:
    type: "shearlet"        # "gabor", "shearlet", "none"
    enabled: true
    hidden_dim: 256
    num_layers: 4
    num_frequencies: 64
    use_energy_gating: true
    
  # Shearlet-specific config
  shearlet:
    num_orientations: 8
    num_frequencies: 4
    hidden_dim: 256
    
  # Fusion method
  fusion:
    type: "energy_gated"    # "energy_gated", "average", "learned"
    temperature: 1.0

# =============================================================================
# TRAINING CONFIGURATION
# =============================================================================
training:
  # Basic settings
  epochs: 150
  batch_size: 8
  num_workers: 0
  
  # Optimizer
  optimizer: "adamw"
  learning_rate: 1e-4
  weight_decay: 1e-5
  
  # Scheduler
  scheduler: "cosine"       # "cosine", "reduce_plateau", "step"
  scheduler_params:
    T_max: 150              # For cosine
    eta_min: 1e-6
    
  # Training techniques
  grad_clip: 1.0
  use_amp: false            # Mixed precision training
  early_stop: 30            # Epochs without improvement
  
  # SOTA Strategies
  sota:
    boundary_loss: true
    boundary_weight: 0.5
    warmup_epochs: 10       # Warmup for boundary loss
    deep_supervision: false
    
  # Point sampling (for fine head)
  point_sampling:
    enabled: false
    num_samples: 4096
    boundary_ratio: 0.5
    
  # Augmentation
  augmentation:
    random_flip: true
    random_rotation: true
    rotation_range: 15

# =============================================================================
# LOSS CONFIGURATION
# =============================================================================
loss:
  ce_weight: 1.0
  dice_weight: 1.0
  focal_weight: 0.0
  focal_gamma: 2.0
  boundary_weight: 0.5
  consistency_weight: 0.1   # For multi-scale consistency
  energy_weight: 0.5        # For energy gating

# =============================================================================
# EVALUATION CONFIGURATION
# =============================================================================
evaluation:
  mode: "3d"                # "2d" (slice-wise) or "3d" (volumetric)
  tta_val: false            # TTA for validation
  tta_test: true            # 8x TTA for test
  tta_modes: ["flip", "rotate90"]

# =============================================================================
# DATA CONFIGURATION
# =============================================================================
data:
  root: "preprocessed_data/ACDC"
  train_dir: "training"
  test_dir: "testing"
  train_split: 0.8          # Train/Val split ratio
  seed: 42                  # Random seed for split

# =============================================================================
# OUTPUT CONFIGURATION
# =============================================================================
output:
  save_dir: "weights"
  exp_name: null            # Auto-generate if null
  save_interval: 50         # Save checkpoint every N epochs
  save_last: true
  save_best: true

# =============================================================================
# LOGGING
# =============================================================================
logging:
  level: "INFO"             # DEBUG, INFO, WARNING, ERROR
  log_interval: 100         # Log every N batches
  val_interval: 1           # Validate every N epochs

# =============================================================================
# PRESETS REFERENCE
# =============================================================================
# These presets can be selected via `preset:` at the top
#
# baseline:
#   - block.type: "basic"
#   - preprocessing.dog.enabled: false
#   - heads.fine.enabled: false
#   - model.components.use_pointrend: false
#
# lite:
#   - block.type: "inverted_residual"
#   - preprocessing.dog.enabled: false
#   - heads.fine.enabled: false
#   - Fast inference, ~5M params
#
# sota:
#   - block.type: "dcn"
#   - block.dilation_pyramid.enabled: true
#   - model.components.use_pointrend: true
#   - training.sota.boundary_loss: true
#   - evaluation.mode: "3d"
#   - Best accuracy, ~25M params
#
# bio:
#   - block.type: "dcn"
#   - preprocessing.dog.enabled: true
#   - heads.fine.type: "shearlet"
#   - Biologically-inspired, DoG + Shearlet
#
# spectral:
#   - block.type: "fno"
#   - model.components.use_spectral: true
#   - Fourier-based processing
#
# attention:
#   - block.type: "swin"
#   - heads.fine.type: "gabor"
#   - Transformer-based attention
# =============================================================================
